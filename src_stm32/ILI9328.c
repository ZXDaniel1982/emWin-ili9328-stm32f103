#include "stm32f1xx_hal.h"
#include "ILI9328.h"

/*
 * Anotação:
 * DB0...DB7 -> PIN0...PIN7
 * RESET -> PIN12
 * CS -> PIN11
 * RS -> PIN10
 * WR -> PIN9
 * RD -> PIN8
 */

static GPIO_InitTypeDef GPIO_InitStructOutput;
static GPIO_InitTypeDef GPIO_InitStructInput;

static void ILI9328_InitIO(void)
{
	GPIO_InitTypeDef GPIO_InitStruct;

	__HAL_RCC_GPIOA_CLK_ENABLE();

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_0|GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_3|GPIO_PIN_4|GPIO_PIN_5|GPIO_PIN_6|GPIO_PIN_7|GPIO_PIN_8|GPIO_PIN_9|GPIO_PIN_10|GPIO_PIN_11|GPIO_PIN_12, GPIO_PIN_RESET);

	GPIO_InitStruct.Pin = GPIO_PIN_0|GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_3|GPIO_PIN_4|GPIO_PIN_5|GPIO_PIN_6|GPIO_PIN_7|GPIO_PIN_8|GPIO_PIN_9|GPIO_PIN_10|GPIO_PIN_11|GPIO_PIN_12;
	GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
	GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
	HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

	// HAL_GPIO_WritePin(GPIOA, GPIO_PIN_0|GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_3
	// 	|GPIO_PIN_4|GPIO_PIN_5|GPIO_PIN_6|GPIO_PIN_7, GPIO_PIN_RESET);
        //
	// GPIO_InitStructOutput.Pin = GPIO_PIN_0|GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_3
	// 	|GPIO_PIN_4|GPIO_PIN_5|GPIO_PIN_6|GPIO_PIN_7;
	// GPIO_InitStructOutput.Mode = GPIO_MODE_OUTPUT_PP;
	// GPIO_InitStructOutput.Speed = GPIO_SPEED_FREQ_LOW;
        //
	// GPIO_InitStructInput.Pin = GPIO_PIN_0|GPIO_PIN_1|GPIO_PIN_2|GPIO_PIN_3
	// 	|GPIO_PIN_4|GPIO_PIN_5|GPIO_PIN_6|GPIO_PIN_7;
	// GPIO_InitStructOutput.Mode = GPIO_MODE_INPUT;
	// GPIO_InitStructOutput.Speed = GPIO_SPEED_FREQ_LOW;
        //
	// HAL_GPIO_Init(GPIOA, &GPIO_InitStructOutput);
}

static void ILI9328_Reset(void)
{
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_12, GPIO_PIN_SET); //RESET
	HAL_Delay(100);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_12, GPIO_PIN_RESET); //RESET
	HAL_Delay(500);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_12, GPIO_PIN_SET); //RESET
	HAL_Delay(500);
}

void ILI9328_Init(void)
{
	ILI9328_InitIO();
	ILI9328_Reset();

	// ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0xE5);
	// ILI9328_WriteRS1(0x78); ILI9328_WriteRS1(0xF0);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x01);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x02);
	ILI9328_WriteRS1(0x04); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x03);
	ILI9328_WriteRS1(0x10); ILI9328_WriteRS1(0x90);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x04);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x08);
	ILI9328_WriteRS1(0x02); ILI9328_WriteRS1(0x02);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x09);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x0A);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x0C);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x0D);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x0F);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	/*----------------------------------------------*/

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x10);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x11);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x07);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x12);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x13);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x07);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x01);

	HAL_Delay(200);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x10);
	ILI9328_WriteRS1(0x16); ILI9328_WriteRS1(0x90);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x11);
	ILI9328_WriteRS1(0x02); ILI9328_WriteRS1(0x27);

	HAL_Delay(50);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x12);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x8C);

	HAL_Delay(50);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x13);
	ILI9328_WriteRS1(0x15); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x29);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x04);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x2B);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x0D);

	HAL_Delay(50);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x20);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x21);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	/*----------------------------------------------*/

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x30);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x31);
	ILI9328_WriteRS1(0x06); ILI9328_WriteRS1(0x07);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x32);
	ILI9328_WriteRS1(0x03); ILI9328_WriteRS1(0x05);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x35);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x36);
	ILI9328_WriteRS1(0x16); ILI9328_WriteRS1(0x04);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x37);
	ILI9328_WriteRS1(0x02); ILI9328_WriteRS1(0x04);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x38);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x01);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x39);
	ILI9328_WriteRS1(0x07); ILI9328_WriteRS1(0x07);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x3C);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x3D);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x0F);

	/*----------------------------------------------*/

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x50);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x51);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0xEF);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x52);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x53);
	ILI9328_WriteRS1(0x01); ILI9328_WriteRS1(0x3F);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x60);
	ILI9328_WriteRS1(0xA7); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x61);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x01);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x6A);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x80);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x81);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x82);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x83);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x84);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x85);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x90);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x10);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x92);
	ILI9328_WriteRS1(0x06); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x07);
	ILI9328_WriteRS1(0x01); ILI9328_WriteRS1(0x33);

	HAL_Delay(50);
}

// void ILI9328_Init(void)
// {
// 	ILI9328_InitIO();
// 	ILI9328_Reset();
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x07);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x12);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// //-----------------------------------------------------------
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x11);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x12);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x29);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x13);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x12);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x10);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// 	HAL_Delay(100);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x10);
// 	ILI9328_WriteRS1(0x01); ILI9328_WriteRS1(0xF0);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x12);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x10);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x11);
// 	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);
//
// 	HAL_Delay(100);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x10);
// 	ILI9328_WriteRS1(0x11); ILI9328_WriteRS1(0xF0);
//
// 	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x07);
// 	ILI9328_WriteRS1(0x01); ILI9328_WriteRS1(0x33);
//
// 	HAL_Delay(10000);
// }

void ILI9328_WriteRS0(uint8_t data)
{
	HAL_GPIO_Init(GPIOA, &GPIO_InitStructOutput);

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_8, GPIO_PIN_SET); // RD
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_9, GPIO_PIN_SET); // WR
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_10, GPIO_PIN_RESET); // RS - A0

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_0, (data & 0x01));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_1, ((data & 0x02) >> 1));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_2, ((data & 0x04) >> 2));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_3, ((data & 0x08) >> 3));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, ((data & 0x10) >> 4));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, ((data & 0x20) >> 5));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_6, ((data & 0x40) >> 6));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_7, ((data & 0x80) >> 7));

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_9, GPIO_PIN_RESET); // WR
	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_9, GPIO_PIN_SET); // WR
	HAL_Delay(1);
}

void ILI9328_WriteRS1(uint8_t data)
{
	HAL_GPIO_Init(GPIOA, &GPIO_InitStructOutput);

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_8, GPIO_PIN_SET); // RD
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_9, GPIO_PIN_SET); // WR
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_10, GPIO_PIN_SET); // RS - A0

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_0, (data & 0x01));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_1, ((data & 0x02) >> 1));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_2, ((data & 0x04) >> 2));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_3, ((data & 0x08) >> 3));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_4, ((data & 0x10) >> 4));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, ((data & 0x20) >> 5));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_6, ((data & 0x40) >> 6));
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_7, ((data & 0x80) >> 7));

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_9, GPIO_PIN_RESET); // WR
	HAL_Delay(1);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_9, GPIO_PIN_SET); // WR
	HAL_Delay(1);
}

void ILI9328_MultiWriteRS1(uint8_t *p_data, int numItems)
{
	for (int i = 0; i < numItems; i++)
		ILI9328_WriteRS1(p_data[i]);
}

uint8_t ILI9328_ReadRS1(void)
{
	uint8_t data;

	HAL_GPIO_Init(GPIOA, &GPIO_InitStructInput);
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_8, GPIO_PIN_RESET); // RD
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_9, GPIO_PIN_SET); // WR
	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_10, GPIO_PIN_SET); // RS - A0

	HAL_Delay(1);
	data = (HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_7) << 7)|
		(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_6) << 6)|
		(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_5) << 5)|
		(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_4) << 4)|
		(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_3) << 3)|
		(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_2) << 2)|
		(HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_1) << 1)|
		HAL_GPIO_ReadPin(GPIOA, GPIO_PIN_0);

	HAL_GPIO_WritePin(GPIOA, GPIO_PIN_8, GPIO_PIN_SET); // RD

	return data;
}

void ILI9328_MultiReadRS1(uint8_t *p_data, int numItems)
{
	for (int i = 0; i < numItems; i++)
		p_data[i] = ILI9328_ReadRS1();
}
