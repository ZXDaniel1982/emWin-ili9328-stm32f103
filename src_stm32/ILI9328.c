#include "stm32f1xx.h"
#include "stm32f1xx_hal.h"
#include "ILI9328.h"

/*
 * Anotação:
 * DB0...DB7 -> PIN0...PIN7
 * RESET -> PIN12
 * CS -> PIN11
 * RS -> PIN10
 * WR -> PIN9
 * RD -> PIN8
 */

static void ILI9328_InitIO(void)
{
	__HAL_RCC_GPIOA_CLK_ENABLE();

	GPIOA->CRL = GPIO_CRL_MODE0_0|GPIO_CRL_MODE1_0|GPIO_CRL_MODE2_0
		|GPIO_CRL_MODE3_0|GPIO_CRL_MODE4_0|GPIO_CRL_MODE5_0
		|GPIO_CRL_MODE6_0|GPIO_CRL_MODE7_0;

	GPIOA->CRH = GPIO_CRH_MODE8_0|GPIO_CRH_MODE9_0|GPIO_CRH_MODE10_0
		|GPIO_CRH_MODE11_0|GPIO_CRH_MODE12_0;

	GPIOA->ODR &= 0xE000;
}

static void ILI9328_Reset(void)
{
	GPIOA->ODR |= GPIO_ODR_ODR12; //RESET
	HAL_Delay(100);
	GPIOA->ODR &= ~GPIO_ODR_ODR12; //RESET
	HAL_Delay(500);
	GPIOA->ODR |= GPIO_ODR_ODR12; //RESET
	HAL_Delay(500);
}

void ILI9328_Init(void)
{
	ILI9328_InitIO();
	ILI9328_Reset();

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0xE5);
	ILI9328_WriteRS1(0x78); ILI9328_WriteRS1(0xF0);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x01);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x02);
	ILI9328_WriteRS1(0x04); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x03);
	ILI9328_WriteRS1(0x10); ILI9328_WriteRS1(0x90);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x04);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x08);
	ILI9328_WriteRS1(0x02); ILI9328_WriteRS1(0x02);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x09);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x0A);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x0C);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x0D);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x0F);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	/*----------------------------------------------*/

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x10);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x11);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x07);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x12);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x13);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x07);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x01);

	HAL_Delay(200);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x10);
	ILI9328_WriteRS1(0x16); ILI9328_WriteRS1(0x90);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x11);
	ILI9328_WriteRS1(0x02); ILI9328_WriteRS1(0x27);

	HAL_Delay(50);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x12);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x8C);

	HAL_Delay(50);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x13);
	ILI9328_WriteRS1(0x15); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x29);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x04);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x2B);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x0D);

	HAL_Delay(50);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x20);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x21);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	/*----------------------------------------------*/

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x30);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x31);
	ILI9328_WriteRS1(0x06); ILI9328_WriteRS1(0x07);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x32);
	ILI9328_WriteRS1(0x03); ILI9328_WriteRS1(0x05);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x35);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x36);
	ILI9328_WriteRS1(0x16); ILI9328_WriteRS1(0x04);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x37);
	ILI9328_WriteRS1(0x02); ILI9328_WriteRS1(0x04);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x38);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x01);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x39);
	ILI9328_WriteRS1(0x07); ILI9328_WriteRS1(0x07);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x3C);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x3D);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x0F);

	/*----------------------------------------------*/

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x50);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x51);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0xEF);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x52);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x53);
	ILI9328_WriteRS1(0x01); ILI9328_WriteRS1(0x3F);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x60);
	ILI9328_WriteRS1(0xA7); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x61);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x01);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x6A);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x80);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x81);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x82);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x83);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x84);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x85);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x90);
	ILI9328_WriteRS1(0x00); ILI9328_WriteRS1(0x10);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x92);
	ILI9328_WriteRS1(0x06); ILI9328_WriteRS1(0x00);

	ILI9328_WriteRS0(0x00); ILI9328_WriteRS0(0x07);
	ILI9328_WriteRS1(0x01); ILI9328_WriteRS1(0x33);

	HAL_Delay(50);
}

void ILI9328_WriteRS0(uint8_t data)
{
	GPIOA->CRL = GPIO_CRL_MODE0_0|GPIO_CRL_MODE1_0|GPIO_CRL_MODE2_0
		|GPIO_CRL_MODE3_0|GPIO_CRL_MODE4_0|GPIO_CRL_MODE5_0
		|GPIO_CRL_MODE6_0|GPIO_CRL_MODE7_0;

	GPIOA->ODR |= GPIO_ODR_ODR8;// RD
	GPIOA->ODR |= GPIO_ODR_ODR9;// WR
	GPIOA->ODR &= ~GPIO_ODR_ODR10;// RS - A0

	GPIOA->ODR &= 0xFF00;
	GPIOA->ODR |= ((uint16_t)data & 0x00FF);

	GPIOA->ODR &= ~GPIO_ODR_ODR9; // WR
	HAL_Delay(1);
	GPIOA->ODR |= GPIO_ODR_ODR9; // WR
	HAL_Delay(1);

	GPIOA->ODR |= GPIO_ODR_ODR10;// RS - A0
}

void ILI9328_WriteRS1(uint8_t data)
{
	GPIOA->CRL = GPIO_CRL_MODE0_0|GPIO_CRL_MODE1_0|GPIO_CRL_MODE2_0
		|GPIO_CRL_MODE3_0|GPIO_CRL_MODE4_0|GPIO_CRL_MODE5_0
		|GPIO_CRL_MODE6_0|GPIO_CRL_MODE7_0;

	GPIOA->ODR |= GPIO_ODR_ODR8;// RD
	GPIOA->ODR |= GPIO_ODR_ODR9;// WR
	GPIOA->ODR |= GPIO_ODR_ODR10;// RS - A0

	GPIOA->ODR &= 0xFF00;
	GPIOA->ODR |= ((uint16_t)data & 0x00FF);

	GPIOA->ODR &= ~GPIO_ODR_ODR9; // WR
	HAL_Delay(1);
	GPIOA->ODR |= GPIO_ODR_ODR9; // WR
	HAL_Delay(1);
}

void ILI9328_MultiWriteRS1(uint8_t *p_data, int numItems)
{
	for (int i = 0; i < numItems; i++)
		ILI9328_WriteRS1(p_data[i]);
}

uint8_t ILI9328_ReadRS1(void)
{
	GPIOA->CRL = GPIO_CRL_CNF7_0|GPIO_CRL_CNF6_0|GPIO_CRL_CNF5_0|
		GPIO_CRL_CNF4_0|GPIO_CRL_CNF3_0|GPIO_CRL_CNF2_0|
		GPIO_CRL_CNF1_0|GPIO_CRL_CNF0_0;

	uint8_t data = 0x00;

	GPIOA->ODR &= ~GPIO_ODR_ODR8;// RD
	GPIOA->ODR |= GPIO_ODR_ODR9;// WR
	GPIOA->ODR |= GPIO_ODR_ODR10;// RS - A0

	HAL_Delay(1);
	data = (uint8_t)GPIOA->IDR & 0xFF;
	GPIOA->ODR |= GPIO_ODR_ODR8;// RD
	
	return data;
}

void ILI9328_MultiReadRS1(uint8_t *p_data, int numItems)
{
	for (int i = 0; i < numItems; i++)
		p_data[i] = ILI9328_ReadRS1();
}
