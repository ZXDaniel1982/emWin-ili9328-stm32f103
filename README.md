# Hello World with emWin display using ILI9328 controller and STM32f103C8

An example project to start developing with the graphic library provided by
STM32F1Cube, SEGGER emWin. Using 2.4 "TFT LCD SHIELD with ILI9328 Controller.

## Hardware

The display:

![disp](https://github.com/rafaellcoellho/emWin-ili9328-stm32f103/blob/master/docs/display.jpg "display")


The wiring diagram with the microcontroller:

![sch](https://github.com/rafaellcoellho/emWin-ili9328-stm32f103/blob/master/docs/sch.png "sch")

## Prerequisites

First you need to clone this repository on your machine.

```
$ git clone https://github.com/rafaellcoellho/emWin-ili9328-stm32f103.git
```

To analyze the code according to the linux kernel code style, the perl
checkpatch script is used. In the scripts folder use dowload.sh to download
directly from /torvalds/linux/scripts. Thanks to riboseinc who write the
[script](https://github.com/riboseinc/checkpatch).

```
$ cd scripts/
$ ./download.sh
```

The static analysis of the code is done through cppcheck. It is open source and
the repository is here in [github](https://github.com/danmar/cppcheck). If you
use ubuntu 14+ or some distro based on it, you can install using:

```
$ sudo apt-get install cppcheck
```

The tests are done with [CppUTest](https://github.com/cpputest/cpputest). You
need to run the setup-cpputest.sh script in the scripts folder. It will
download the test framework inside the project tree.

```
$ cd scripts/
$ ./setup-cpputest.sh
```
Let's use the gcc toolchain for ARM. You must install the compiler, assembler,
linker, and some utilities.

```
$ sudo apt-get install gcc-arm-none-eabi gdb-arm-none-eabi binutils-arm-none-eabi libnewlib-arm-none-eabi
```

To upload the program to the target processor, the
[stlink](https://github.com/texane/stlink) will be used. Instructions on how to
install are in the following
[article](https://github.com/texane/stlink/blob/master/doc/compiling.md).
Install the following programs:

```
$ sudo apt-get install libusb-1.0 libusb-1.0.0-dev python-usb
```

## Directories

- build - All files generated by the compilation are here.
- cpputest - The cpputest project, downloaded and compiled by
`setup-cpputest.sh`.
- drivers - All libraries goes in there.
- scripts - All scripts written in shell required for the environment.
- src - Where the application src goes, only platform independent code here.
- src_stm32 - Where platform dependent code goes.
- src_tests - Code in c ++ to be tested with the cpputest framework.

## Usage

This repository is only a reference for projects with graphical interface using
emWin. The important part is the way of writing the functions to fit any
display to the library. The ILI9328.c and ILI9328.h files are the
implementation of these functions for the display controller ili9328 and
should be used as a reference.

```C
void ILI9328_Init(void);
void ILI9328_WriteRS0(uint8_t data);
void ILI9328_WriteRS1(uint8_t data);
void ILI9328_MultiWriteRS1(uint8_t *p_data, int numItems);
uint8_t ILI9328_ReadRS1(void);
void ILI9328_MultiReadRS1(uint8_t *p_data, int numItems);
```

The LCDConf.c file is what gets the pointers to the functions for ili9328.

```C
void LCD_X_Config(void) {
  GUI_DEVICE *pDevice;
  CONFIG_FLEXCOLOR Config = {0};
  GUI_PORT_API PortAPI = {0};
  //
  // Set display driver and color conversion
  //
  pDevice = GUI_DEVICE_CreateAndLink(GUIDRV_FLEXCOLOR, GUICC_565, 0, 0);
  //
  // Display driver configuration, required for Lin-driver
  //
  LCD_SetSizeEx (0, XSIZE_PHYS, YSIZE_PHYS);
  // LCD_SetVSizeEx(0, VXSIZE_PHYS, VYSIZE_PHYS);
  //
  // Orientation
  //
  Config.Orientation = GUI_SWAP_XY;
  GUIDRV_FlexColor_Config(pDevice, &Config);
  //
  // Set controller and operation mode
  //
  PortAPI.pfWrite8_A0  = ILI9328_WriteRS0;
  PortAPI.pfWrite8_A1  = ILI9328_WriteRS1;
  PortAPI.pfWriteM8_A1 = ILI9328_MultiWriteRS1;
  PortAPI.pfRead8_A1 = ILI9328_ReadRS1;
  PortAPI.pfReadM8_A1  = ILI9328_MultiReadRS1;
  GUIDRV_FlexColor_SetFunc(pDevice, &PortAPI, GUIDRV_FLEXCOLOR_F66708, GUIDRV_FLEXCOLOR_M16C0B8);
}
```

You must also include the makefile in the STMWINLIB variable.

```shell
STEMWINLIBPATH= drivers/STemWin
[...]
STMWINLIB = $(STEMWINLIBPATH)/STemWin532_CM3_GCC.a
[...]
$(TARGET).elf: $(OBJECTS)
	$(CC) $(OBJECTS) $(STMWINLIB) $(LDFLAGS) -o $@
	$(SZ) $@
```

When testing this program, it is expected to appear:

![hello](https://github.com/rafaellcoellho/emWin-ili9328-stm32f103/blob/master/docs/P_20180129_111951.jpg "hello world")

## Authors

* **Rafael Coelho** - [rafaellcoellho](https://github.com/rafaellcoellho)

## License

This repository contains the full version of STemWin contained in STM32CubeF1
v1.6.0. It is on the terms of the cleared license
[here](http://www.st.com/content/st_com/en/products/embedded-software/mcus-embedded-software/stm32-embedded-software/stm32cube-mcu-packages/stm32cubef1.html).
